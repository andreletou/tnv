<!DOCTYPE html>
{% load static %}
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Local-Links pour les commerçants et clients">
    <meta name="theme-color" content="#10b981">
    <title>{% block title %}Local-Links{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Local-links">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#17c574ff',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    
    {% block extra_css %}{% endblock %}
</head>
<body class="h-full bg-consistent-gray text-consistent-primary">
    <!-- Flash Messages -->
    {% if messages %}
        <div class="fixed top-0 left-0 right-0 z-50 p-4 space-y-2">
            {% for message in messages %}
                <div class="animate-slide-up max-w-sm mx-auto rounded-lg shadow-lg p-4 
                            {% if message.tags == 'success' %}bg-green-500 text-white
                            {% elif message.tags == 'error' %}bg-red-500 text-white
                            {% elif message.tags == 'warning' %}bg-yellow-500 text-white
                            {% else %}bg-blue-500 text-white{% endif %}">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium">{{ message }}</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main class="min-h-screen pb-20">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation (Mobile) -->
    {% if user.is_authenticated %}
        <nav class="fixed bottom-0 left-0 right-0 nav-consistent bottom-nav z-40">
            <div class="grid grid-cols-5 h-16">
                {% if request.resolver_match.app_name == 'clients' %}
                    <a href="{% url 'clients:accueil' %}" class="flex flex-col items-center justify-center nav-item-consistent active transition-colors">
                        <i class="fas fa-home text-xl mb-1"></i>
                        <span class="text-xs">Accueil</span>
                    </a>
                    <a href="{% url 'clients:liste_boutiques' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-store text-xl mb-1"></i>
                        <span class="text-xs">Boutiques</span>
                    </a>
                    <a href="{% url 'clients:panier' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors relative">
                        <i class="fas fa-shopping-cart text-xl mb-1"></i>
                        <span class="text-xs">Panier</span>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </a>
                    <a href="{% url 'clients:mes_commandes' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-receipt text-xl mb-1"></i>
                        <span class="text-xs">Commandes</span>
                    </a>
                    <a href="{% url 'clients:profil' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-user text-xl mb-1"></i>
                        <span class="text-xs">Profil</span>
                    </a>
                {% elif request.resolver_match.app_name == 'commercants' %}
                    <a href="{% url 'commercants:tableau_de_bord' %}" class="flex flex-col items-center justify-center nav-item-consistent active transition-colors">
                        <i class="fas fa-tachometer-alt text-xl mb-1"></i>
                        <span class="text-xs">Tableau</span>
                    </a>
                    <a href="{% url 'commercants:liste_produits' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-box text-xl mb-1"></i>
                        <span class="text-xs">Produits</span>
                    </a>
                    <a href="{% url 'commercants:liste_promotions' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-tag text-xl mb-1"></i>
                        <span class="text-xs">Promos</span>
                    </a>
                    <a href="{% url 'commercants:gestion_commandes' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-shopping-bag text-xl mb-1"></i>
                        <span class="text-xs">Commandes</span>
                    </a>
                    <a href="{% url 'commercants:profil' %}" class="flex flex-col items-center justify-center nav-item-consistent transition-colors">
                        <i class="fas fa-user text-xl mb-1"></i>
                        <span class="text-xs">Profil</span>
                    </a>
                {% endif %}
            </div>
        </nav>
    {% endif %}

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="card-consistent rounded-lg p-6 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-consistent-secondary">Chargement...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/api.js' %}"></script>
    {% block extra_js %}{% endblock %}
    <script>
        // ===== FONCTIONS UTILITAIRES =====
        
        // Fonction pour récupérer les cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Fonction pour afficher les notifications
        function showToast(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Créer une notification toast
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg animate-slide-up ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-supprimer après 5 secondes
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // ===== API FUNCTIONS =====
        
        const API = {
            Cart: {
                async addItem(produitId, quantite = 1) {
                    try {
                        const response = await fetch('/clients/api/panier/ajouter/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId,
                                quantite: quantite
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                            this.updateCartUI(data);
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de l\'ajout au panier', 'error');
                    }
                },
                
                async updateItem(itemId, quantite) {
                    try {
                        const response = await fetch('/clients/api/panier/modifier/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                item_id: itemId,
                                quantite: quantite
                            })
                        });
                        
                        return await response.json();
                    } catch (error) {
                        console.error('Erreur:', error);
                        return { success: false, message: 'Erreur de connexion' };
                    }
                },
                
                async removeItem(itemId) {
                    try {
                        const response = await fetch('/clients/api/panier/supprimer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                item_id: itemId
                            })
                        });
                        
                        return await response.json();
                    } catch (error) {
                        console.error('Erreur:', error);
                        return { success: false, message: 'Erreur de connexion' };
                    }
                },
                
                async getInfo() {
                    try {
                        const response = await fetch('/clients/api/panier/infos/');
                        return await response.json();
                    } catch (error) {
                        console.error('Erreur:', error);
                        return { success: false };
                    }
                },
                
                updateCartUI(data) {
                    // Mettre à jour le compteur du panier
                    const cartCountElement = document.getElementById('cart-count');
                    if (cartCountElement && data.nombre_articles !== undefined) {
                        cartCountElement.textContent = data.nombre_articles;
                        if (data.nombre_articles > 0) {
                            cartCountElement.classList.remove('hidden');
                        } else {
                            cartCountElement.classList.add('hidden');
                        }
                    }
                    
                    // Mettre à jour le total du panier si l'élément existe
                    const cartTotalElement = document.getElementById('cart-total');
                    if (cartTotalElement && data.total_panier !== undefined) {
                        cartTotalElement.textContent = `${data.total_panier.toFixed(0)} FCFA`;
                    }
                }
            },
            
            Favorites: {
                async add(produitId) {
                    try {
                        const response = await fetch('/clients/api/favoris/ajouter/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de l\'ajout aux favoris', 'error');
                        return { success: false };
                    }
                },
                
                async remove(produitId) {
                    try {
                        const response = await fetch('/clients/api/favoris/supprimer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de la suppression des favoris', 'error');
                        return { success: false };
                    }
                }
            },
            
            Reviews: {
                async add(produitId, note, commentaire = '') {
                    try {
                        const response = await fetch('/clients/api/avis/ajouter/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId,
                                note: note,
                                commentaire: commentaire
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de l\'ajout de l\'avis', 'error');
                        return { success: false };
                    }
                }
            },
            
            Promotions: {
                async toggle(produitId) {
                    try {
                        const response = await fetch('/commercants/api/toggle-promotion/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de la modification', 'error');
                        return { success: false };
                    }
                },
                
                async delete(produitId) {
                    try {
                        const response = await fetch('/commercants/api/delete-promotion/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify({
                                produit_id: produitId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast('Erreur lors de la suppression', 'error');
                        return { success: false };
                    }
                }
            }
        };

        // ===== FONCTIONS GLOBALES =====
        
        // Fonction pour basculer l'état de promotion
        function togglePromotion(produitId) {
            if (!confirm('Voulez-vous modifier l\'état de cette promotion ?')) {
                return;
            }
            
            API.Promotions.toggle(produitId).then(data => {
                if (data.success) {
                    // La page ne sera plus rechargée automatiquement
                    // L'utilisateur peut rafraîchir manuellement si nécessaire
                }
            });
        }

        // Fonction pour supprimer une promotion
        function deletePromotion(produitId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette promotion ?')) {
                return;
            }
            
            API.Promotions.delete(produitId).then(data => {
                if (data.success) {
                    // La page ne sera plus rechargée automatiquement
                    // L'utilisateur peut rafraîchir manuellement si nécessaire
                }
            });
        }

        // ===== INITIALISATION =====
        
        document.addEventListener('DOMContentLoaded', function() {
            // Mettre à jour le compteur du panier
            if (document.getElementById('cart-count')) {
                API.Cart.getInfo().then(data => {
                    if (data.success) {
                        API.Cart.updateCartUI(data);
                    }
                });
            }
            
            // Auto-hide flash messages
            setTimeout(() => {
                const messages = document.querySelectorAll('[class*="animate-slide-up"]');
                messages.forEach(msg => {
                    setTimeout(() => {
                        if (msg.parentElement) {
                            msg.remove();
                        }
                    }, 5000);
                });
            }, 3000);
        });

        // ===== PWA FUNCTIONALITY =====
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            // Vérifier si le bouton n'existe pas déjà
            if (document.getElementById('pwa-install-btn')) return;
            
            const installBtn = document.createElement('button');
            installBtn.id = 'pwa-install-btn';
            installBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Installer l\'app';
            installBtn.className = 'fixed bottom-20 right-4 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg z-30 hover:bg-primary-700 transition-colors';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Résultat de l'installation: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            };
            document.body.appendChild(installBtn);
        }
    </script>


</body>
</html>