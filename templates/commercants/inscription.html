{% extends 'base.html' %}
{% load static %}

{% block title %}Inscription Commerçant{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12">
    <!-- Header -->
    <header class="bg-white shadow-sm mb-8">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-lg font-semibold">Créer ma boutique</h1>
                <div class="w-9"></div>
            </div>
        </div>
    </header>

    <div class="px-4 max-w-2xl mx-auto">
        <!-- Progress indicator -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div id="step1" class="w-8 h-8 bg-primary text-gray-50 rounded-full flex items-center justify-center text-sm font-medium">1</div>
                    <div class="w-16 h-1 bg-gray-200 mx-2"></div>
                </div>
                <div class="flex items-center">
                    <div id="step2" class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center text-sm font-medium">2</div>
                    <div class="w-16 h-1 bg-gray-200 mx-2"></div>
                </div>
                <div class="flex items-center">
                    <div id="step3" class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center text-sm font-medium">3</div>
                </div>
            </div>
            <div class="flex justify-between mt-2">
                <span class="text-xs text-gray-600">Informations</span>
                <span class="text-xs text-gray-600">Boutique</span>
                <span class="text-xs text-gray-600">Confirmation</span>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="inscriptionForm">
            {% csrf_token %}
            
            <!-- Step 1: Informations personnelles -->
            <div id="formStep1" class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Informations personnelles</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prénom *</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom *</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.email.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur *</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.username.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Téléphone *</label>
                        {{ form.telephone }}
                        {% if form.telephone.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.telephone.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe *</label>
                        {{ form.password1 }}
                        {% if form.password1.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.password1.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmer mot de passe *</label>
                        {{ form.password2 }}
                        {% if form.password2.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.password2.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Step 2: Informations boutique -->
            <div id="formStep2" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden">
                <h2 class="text-lg font-semibold mb-4">Informations de la boutique</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la boutique *</label>
                    {{ form.nom_boutique }}
                    {% if form.nom_boutique.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.nom_boutique.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie *</label>
                    {{ form.categorie }}
                    {% if form.categorie.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.categorie.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adresse complète *</label>
                    {{ form.adresse }}
                    {% if form.adresse.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.adresse.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Photo de la boutique</label>
                    <div class="flex items-center space-x-4">
                        <img id="photoPreview" src="{% static 'images/default-store.png' %}" alt="Photo boutique" class="w-20 h-20 rounded-lg object-cover border-2 border-gray-200">
                        <div>
                            {{ form.photo_boutique }}
                            <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (max 5MB)</p>
                        </div>
                    </div>
                    {% if form.photo_boutique.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.photo_boutique.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Heure d'ouverture *</label>
                        {{ form.horaire_ouverture }}
                        {% if form.horaire_ouverture.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.horaire_ouverture.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Heure de fermeture *</label>
                        {{ form.horaire_fermeture }}
                        {% if form.horaire_fermeture.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.horaire_fermeture.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jours d'ouverture *</label>
                    {{ form.jours_ouverture }}
                    {% if form.jours_ouverture.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.jours_ouverture.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Step 3: Confirmation -->
            <div id="formStep3" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden">
                <h2 class="text-lg font-semibold mb-4">Confirmation</h2>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-medium text-blue-900 mb-2">Récapitulatif de votre boutique</h3>
                    <div id="recapitulatif" class="text-sm text-blue-800 space-y-1">
                        <!-- Will be filled by JavaScript -->
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-medium mb-2">Conditions générales</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        <p>En créant votre boutique, vous acceptez :</p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>Les conditions générales de vente</li>
                            <li>La politique de confidentialité</li>
                            <li>Les règles de la plateforme</li>
                        </ul>
                    </div>
                    
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="acceptConditions" class="mt-1" required>
                        <span class="text-sm text-gray-700">
                            J'accepte les conditions générales et m'engage à respecter les règles de la plateforme
                        </span>
                    </label>
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="flex justify-between">
                <button type="button" id="prevBtn" onclick="changeStep(-1)" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors hidden">
                    Précédent
                </button>
                <button type="button" id="nextBtn" onclick="changeStep(1)" class="px-6 py-2 bg-primary text-gray-50 rounded-lg hover:bg-primary/90 transition-colors ml-auto">
                    Suivant
                </button>
                <button type="submit" id="submitBtn" class="px-6 py-2 bg-primary text-gray-50 rounded-lg hover:bg-primary/90 transition-colors hidden">
                    Créer ma boutique
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-xs mx-4">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
            <p class="text-sm text-gray-600">Création de votre boutique...</p>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 3;

document.addEventListener('DOMContentLoaded', function() {
    // Style form inputs
    const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="password"], textarea, select');
    inputs.forEach(input => {
        input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-lg', 'focus:ring-2', 'focus:ring-primary', 'focus:border-transparent');
    });
    
    // File input styling
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.classList.add('hidden');
        fileInput.addEventListener('change', previewPhoto);
    }
    
    // Form submission
    document.getElementById('inscriptionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const acceptConditions = document.getElementById('acceptConditions');
        if (!acceptConditions.checked) {
            showToast('Veuillez accepter les conditions générales', 'error');
            return;
        }
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Submit form
        setTimeout(() => {
            this.submit();
        }, 2000);
    });
});

function changeStep(direction) {
    const currentStepDiv = document.getElementById(`formStep${currentStep}`);
    
    if (direction === 1) {
        // Validate current step
        if (!validateStep(currentStep)) {
            return;
        }
    }
    
    // Hide current step
    currentStepDiv.classList.add('hidden');
    
    // Update step
    currentStep += direction;
    
    // Show new step
    const newStepDiv = document.getElementById(`formStep${currentStep}`);
    newStepDiv.classList.remove('hidden');
    
    // Update progress indicators
    updateProgressIndicators();
    
    // Update buttons
    updateButtons();
    
    // If moving to step 3, generate recap
    if (currentStep === 3) {
        generateRecapitulatif();
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(step) {
    let isValid = true;
    const stepDiv = document.getElementById(`formStep${step}`);
    const requiredFields = stepDiv.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });
    
    // Password validation for step 1
    if (step === 1) {
        const password1 = document.querySelector('input[name="password1"]').value;
        const password2 = document.querySelector('input[name="password2"]').value;
        
        if (password1 !== password2) {
            showToast('Les mots de passe ne correspondent pas', 'error');
            isValid = false;
        }
        
        if (password1.length < 8) {
            showToast('Le mot de passe doit contenir au moins 8 caractères', 'error');
            isValid = false;
        }
    }
    
    if (!isValid) {
        showToast('Veuillez remplir tous les champs obligatoires', 'error');
    }
    
    return isValid;
}

function updateProgressIndicators() {
    for (let i = 1; i <= totalSteps; i++) {
        const stepIndicator = document.getElementById(`step${i}`);
        if (i <= currentStep) {
            stepIndicator.classList.remove('bg-gray-200', 'text-gray-600');
            stepIndicator.classList.add('bg-primary', 'text-gray');
        } else {
            stepIndicator.classList.remove('bg-primary', 'text-gray');
            stepIndicator.classList.add('bg-gray-200', 'text-gray-600');
        }
    }
}

function updateButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    if (currentStep === 1) {
        prevBtn.classList.add('hidden');
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
    } else if (currentStep === totalSteps) {
        prevBtn.classList.remove('hidden');
        nextBtn.classList.add('hidden');
        submitBtn.classList.remove('hidden');
    } else {
        prevBtn.classList.remove('hidden');
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
    }
}

function generateRecapitulatif() {
    const nomBoutique = document.querySelector('input[name="nom_boutique"]').value;
    const categorie = document.querySelector('select[name="categorie"]').value;
    const description = document.querySelector('textarea[name="description"]').value;
    const adresse = document.querySelector('textarea[name="adresse"]').value;
    const horaireOuverture = document.querySelector('input[name="horaire_ouverture"]').value;
    const horaireFermeture = document.querySelector('input[name="horaire_fermeture"]').value;
    const joursOuverture = document.querySelector('input[name="jours_ouverture"]').value;
    
    const recapHTML = `
        <p><strong>Nom:</strong> ${nomBoutique}</p>
        <p><strong>Catégorie:</strong> ${categorie}</p>
        <p><strong>Adresse:</strong> ${adresse}</p>
        <p><strong>Horaires:</strong> ${joursOuverture} de ${horaireOuverture} à ${horaireFermeture}</p>
        ${description ? `<p><strong>Description:</strong> ${description.substring(0, 100)}${description.length > 100 ? '...' : ''}</p>` : ''}
    `;
    
    document.getElementById('recapitulatif').innerHTML = recapHTML;
}

function previewPhoto(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('photoPreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// Phone number formatting
document.querySelector('input[name="telephone"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    if (value.startsWith('+228')) {
        value = '+228 ' + value.substring(4).replace(/(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4');
    }
    e.target.value = value;
});

// Auto-save draft
let autoSaveTimer;
document.getElementById('inscriptionForm').addEventListener('input', function() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (value instanceof File && value.size === 0) continue;
            data[key] = value;
        }
        localStorage.setItem('commercant_draft', JSON.stringify(data));
    }, 3000);
});
</script>

<style>
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}