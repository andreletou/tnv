{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titre }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-lg font-semibold">{{ titre }}</h1>
                </div>
                <button type="submit" form="produitForm" class="text-primary font-medium">
                    Enregistrer
                </button>
            </div>
        </div>
    </header>

    <form method="post" enctype="multipart/form-data" id="produitForm">
        {% csrf_token %}
        
        <!-- Photo du produit -->
        <div class="bg-white p-4 mb-2">
            <h3 class="font-semibold mb-4">Photo du produit</h3>
            <div class="text-center">
                <div class="relative inline-block mb-4">
                    <img id="photoPreview" 
                         src="{% if form.instance.photo %}{{ form.instance.photo.url }}{% else %}{% static 'images/default-product.png' %}{% endif %}" 
                         alt="Photo du produit" 
                         class="w-32 h-32 rounded-lg border-2 border-gray-200 object-cover">
                    <label for="id_photo" class="absolute bottom-2 right-2 bg-primary text-gray-50 p-2 rounded-full cursor-pointer hover:bg-primary/90 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </label>
                    <input type="file" id="id_photo" name="photo" accept="image/*" class="hidden" onchange="previewPhoto(event)">
                </div>
                <p class="text-sm text-gray-500">Appuyez sur l'icône pour changer la photo</p>
                <p class="text-xs text-gray-400 mt-1">Format: JPG, PNG (max 5MB)</p>
            </div>
        </div>

        <!-- Informations de base -->
        <div class="bg-white p-4 mb-2">
            <h3 class="font-semibold mb-4">Informations de base</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom du produit *</label>
                    {{ form.nom }}
                    {% if form.nom.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.nom.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.description.value|length|default:0 }}/500 caractères</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie *</label>
                    {{ form.categorie }}
                    {% if form.categorie.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.categorie.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prix et stock -->
        <div class="bg-white p-4 mb-2">
            <h3 class="font-semibold mb-4">Prix et stock</h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prix normal (XOF) *</label>
                        {{ form.prix }}
                        {% if form.prix.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.prix.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prix promotionnel (XOF)</label>
                        {{ form.prix_promotionnel }}
                        {% if form.prix_promotionnel.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.prix_promotionnel.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock disponible *</label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.stock.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock minimum</label>
                        {{ form.stock_min }}
                        {% if form.stock_min.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.stock_min.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Alerte quand le stock est bas</p>
                    </div>
                </div>

                <!-- Prix calculé -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Prix de vente effectif</span>
                        <span id="prixEffectif" class="text-lg font-bold text-primary">0 XOF</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Options -->
        <div class="bg-white p-4 mb-20">
            <h3 class="font-semibold mb-4">Options</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-sm">Produit actif</p>
                        <p class="text-xs text-gray-500">Visible et disponible à la vente</p>
                    </div>
                    {{ form.est_actif }}
                </div>

                <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-sm">En promotion</p>
                        <p class="text-xs text-gray-500">Afficher comme produit promotionnel</p>
                    </div>
                    {{ form.est_en_promotion }}
                </div>
            </div>
        </div>
    </form>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-xs mx-4">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p class="text-sm text-gray-600">Enregistrement en cours...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('produitForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Style form inputs
    const inputs = form.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
    inputs.forEach(input => {
        input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-lg', 'focus:ring-2', 'focus:ring-primary', 'focus:border-transparent');
    });
    
    // Style checkboxes
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.classList.add('w-4', 'h-4', 'text-primary', 'border-gray-300', 'rounded', 'focus:ring-primary');
    });
    
    // Calculate effective price
    const prixInput = document.querySelector('input[name="prix"]');
    const prixPromoInput = document.querySelector('input[name="prix_promotionnel"]');
    const promoCheckbox = document.querySelector('input[name="est_en_promotion"]');
    
    function updatePrixEffectif() {
        const prix = parseFloat(prixInput.value) || 0;
        const prixPromo = parseFloat(prixPromoInput.value) || 0;
        const enPromo = promoCheckbox.checked;
        
        const prixEffectif = enPromo && prixPromo > 0 ? prixPromo : prix;
        document.getElementById('prixEffectif').textContent = formatPrice(prixEffectif);
    }
    
    prixInput.addEventListener('input', updatePrixEffectif);
    prixPromoInput.addEventListener('input', updatePrixEffectif);
    promoCheckbox.addEventListener('change', updatePrixEffectif);
    
    // Initialize
    updatePrixEffectif();
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate
        if (!validateForm()) {
            return;
        }
        
        // Show loading
        loadingOverlay.classList.remove('hidden');
        
        // Create FormData for file upload
        const formData = new FormData(form);
        
        // Submit via fetch
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.classList.add('hidden');
            
            if (data.success) {
                showToast('Produit enregistré avec succès', 'success');
                setTimeout(() => {
                    window.location.href = '/commercants/produits/';
                }, 1500);
            } else {
                if (data.errors) {
                    // Display errors
                    Object.keys(data.errors).forEach(field => {
                        const input = form.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                            const errorDiv = document.createElement('p');
                            errorDiv.className = 'text-red-500 text-xs mt-1';
                            errorDiv.textContent = data.errors[field][0];
                            input.parentNode.appendChild(errorDiv);
                        }
                    });
                } else {
                    showToast(data.message || 'Erreur lors de l\'enregistrement', 'error');
                }
            }
        })
        .catch(error => {
            loadingOverlay.classList.add('hidden');
            console.error('Error:', error);
            
            // Fallback to normal form submission
            form.submit();
        });
    });
    
    // Character counter for description
    const textarea = form.querySelector('textarea[name="description"]');
    if (textarea) {
        textarea.addEventListener('input', function() {
            const counter = this.parentNode.querySelector('.text-gray-500');
            if (counter) {
                counter.textContent = `${this.value.length}/500 caractères`;
                if (this.value.length > 500) {
                    this.value = this.value.substring(0, 500);
                    counter.classList.add('text-red-500');
                } else {
                    counter.classList.remove('text-red-500');
                }
            }
        });
    }
    
    // Auto-save draft
    let autoSaveTimer;
    form.addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value instanceof File && value.size === 0) continue;
                data[key] = value;
            }
            localStorage.setItem('produit_draft', JSON.stringify(data));
        }, 2000);
    });
    
    // Load draft if exists and it's a new product
    {% if not form.instance.pk %}
    const draft = localStorage.getItem('produit_draft');
    if (draft) {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && data[key]) {
                if (input.type === 'checkbox') {
                    input.checked = data[key] === 'on' || data[key] === true;
                } else {
                    input.value = data[key];
                }
            }
        });
        updatePrixEffectif();
    }
    {% endif %}
    
    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('produit_draft');
    });
});

function previewPhoto(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('photoPreview');
    
    if (file) {
        // Validate file size
        if (file.size > 5 * 1024 * 1024) {
            showToast('L\'image ne doit pas dépasser 5MB', 'error');
            event.target.value = '';
            return;
        }
        
        // Validate file type
        if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
            showToast('Format d\'image non supporté (JPG, PNG uniquement)', 'error');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function validateForm() {
    const form = document.getElementById('produitForm');
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });
    
    // Validate prices
    const prix = parseFloat(form.querySelector('input[name="prix"]').value) || 0;
    const prixPromo = parseFloat(form.querySelector('input[name="prix_promotionnel"]').value) || 0;
    
    if (prix <= 0) {
        form.querySelector('input[name="prix"]').classList.add('border-red-500');
        showToast('Le prix doit être supérieur à 0', 'error');
        isValid = false;
    }
    
    if (prixPromo > 0 && prixPromo >= prix) {
        form.querySelector('input[name="prix_promotionnel"]').classList.add('border-red-500');
        showToast('Le prix promotionnel doit être inférieur au prix normal', 'error');
        isValid = false;
    }
    
    // Validate stock
    const stock = parseInt(form.querySelector('input[name="stock"]').value) || 0;
    if (stock < 0) {
        form.querySelector('input[name="stock"]').classList.add('border-red-500');
        showToast('Le stock ne peut pas être négatif', 'error');
        isValid = false;
    }
    
    if (!isValid) {
        showToast('Veuillez corriger les erreurs', 'error');
    }
    
    return isValid;
}

function formatPrice(amount) {
    return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'XOF',
        minimumFractionDigits: 0
    }).format(amount);
}

// Remove error styling on input
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('border-red-500')) {
        e.target.classList.remove('border-red-500');
        const errorDiv = e.target.parentNode.querySelector('.text-red-500');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
});

// Auto-fill promotion price when promotion is enabled
document.querySelector('input[name="est_en_promotion"]')?.addEventListener('change', function() {
    if (this.checked) {
        const prix = parseFloat(document.querySelector('input[name="prix"]').value) || 0;
        const prixPromo = document.querySelector('input[name="prix_promotionnel"]');
        
        if (prix > 0 && !prixPromo.value) {
            // Suggest 20% discount
            const suggestedPrice = Math.round(prix * 0.8);
            prixPromo.value = suggestedPrice;
            updatePrixEffectif();
        }
    }
});
</script>

<style>
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

input[type="date"]::-webkit-calendar-picker-indicator,
input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(0.5);
}

input[type="file"]::-webkit-file-upload-button {
    visibility: hidden;
}
</style>
{% endblock %}