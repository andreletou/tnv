{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Local-Links - Accueil{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header avec recherche -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-store text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Local-Links</h1>
                        <p class="text-xs text-gray-500">Livraison rapide</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-bell text-gray-600"></i>
                    </button>
                    {% if user.is_authenticated %}
                    <a href="{% url 'clients:profil' %}" class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold">
                        {{ user.first_name|first|default:user.username|first }}
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="relative">
                <input type="text" 
                       placeholder="Rechercher des produits..." 
                       class="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-800 placeholder-gray-500"
                       onclick="openSearchModal()">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
    </header>

    <!-- Banni√®re promotionnelle -->
    <div class="px-4 py-3">
        <div class="bg-gradient-to-r from-green-600 to-green-700 rounded-2xl p-4 text-white relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-lg font-bold mb-1">Livraison Express</h2>
                <p class="text-sm opacity-90 mb-3">Commandez avant 18h, recevez aujourd'hui !</p>
                <button class="bg-white text-green-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors">
                    Commander maintenant
                </button>
            </div>
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 opacity-20">
                <i class="fas fa-shipping-fast text-6xl"></i>
            </div>
        </div>
    </div>

    <!-- Cat√©gories rapides -->
    <div class="px-4 py-4">
        <h2 class="text-lg font-bold text-gray-900 mb-3">Cat√©gories</h2>
        <div class="grid grid-cols-4 gap-3">
            <a href="{% url 'clients:liste_boutiques' %}?categorie=restaurant" class="category-card bg-white rounded-2xl p-3 text-center shadow-sm hover:shadow-md transition-shadow">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-utensils text-green-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-700">Restaurants</span>
            </a>
            <a href="{% url 'clients:liste_boutiques' %}?categorie=epicerie" class="category-card bg-white rounded-2xl p-3 text-center shadow-sm hover:shadow-md transition-shadow">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-shopping-basket text-blue-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-700">√âpicerie</span>
            </a>
            <a href="{% url 'clients:liste_boutiques' %}?categorie=mode" class="category-card bg-white rounded-2xl p-3 text-center shadow-sm hover:shadow-md transition-shadow">
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-tshirt text-purple-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-700">Mode</span>
            </a>
            <a href="{% url 'clients:liste_boutiques' %}?categorie=electronique" class="category-card bg-white rounded-2xl p-3 text-center shadow-sm hover:shadow-md transition-shadow">
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-laptop text-orange-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-700">High-Tech</span>
            </a>
        </div>
    </div>

    <!-- Produits en tendance -->
    {% if produits_tendance %}
    <section class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">üî• Produits tendance</h2>
            <a href="{% url 'clients:recherche' %}?tri=populaire" class="text-green-600 text-sm font-semibold flex items-center">
                Tout voir
                <i class="fas fa-chevron-right ml-1 text-xs"></i>
            </a>
        </div>
        
        <div class="flex space-x-4 overflow-x-auto scrollbar-hide pb-2">
            {% for produit in produits_tendance %}
            <div class="flex-shrink-0 w-40">
                <div class="product-card bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                    <a href="{% url 'clients:detail_produit' produit.id %}" class="block">
                        <div class="relative">
                            {% if produit.photo %}
                                <img src="{{ produit.photo.url }}" 
                                     alt="{{ produit.nom }}" 
                                     class="w-full h-32 object-cover">
                            {% else %}
                                <div class="w-full h-32 bg-gradient-to-br from-orange-100 to-red-100 flex items-center justify-center">
                                    <i class="fas fa-fire text-orange-400 text-xl"></i>
                                </div>
                            {% endif %}
                            
                            <span class="absolute top-2 left-2 px-2 py-1 bg-orange-500 text-white text-xs font-semibold rounded-full">
                                Tendance
                            </span>
                            
                            <button class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center hover:shadow-lg transition-shadow"
                                    onclick="event.preventDefault(); toggleFavorite({{ produit.id }}, this)">
                                <i class="fas fa-heart text-gray-400 text-sm"></i>
                            </button>
                        </div>
                        
                        <div class="p-3">
                            <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-1">{{ produit.nom }}</h3>
                            <p class="text-xs text-gray-500 mb-2">{{ produit.commercant.nom_boutique }}</p>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-base font-bold text-green-600">{{ produit.prix_effectif|format_currency }}</span>
                                <button class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors"
                                        onclick="event.preventDefault(); API.Cart.addItem({{ produit.id }})">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Boutiques proches -->
    {% if boutiques %}
    <section class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">üè™ Boutiques pr√®s de vous</h2>
            <a href="{% url 'clients:liste_boutiques' %}" class="text-green-600 text-sm font-semibold flex items-center">
                Tout voir
                <i class="fas fa-chevron-right ml-1 text-xs"></i>
            </a>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            {% for boutique_data in boutiques_data|slice:":4" %}
            <div class="boutique-card bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                <a href="{% url 'clients:detail_boutique' boutique_data.boutique.id %}" class="block">
                    <div class="relative">
                        {% if boutique_data.boutique.photo_boutique %}
                            <img src="{{ boutique_data.boutique.photo_boutique.url }}" 
                                 alt="{{ boutique_data.boutique.nom_boutique }}" 
                                 class="w-full h-28 object-cover">
                        {% else %}
                            <div class="w-full h-28 bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center">
                                <i class="fas fa-store text-blue-400 text-2xl"></i>
                            </div>
                        {% endif %}
                        
                        <div class="absolute bottom-2 left-2">
                            <span class="px-2 py-1 bg-black bg-opacity-70 text-white text-xs rounded-full">
                                üìç Proche
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-3">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="text-sm font-semibold text-gray-900 truncate">{{ boutique_data.boutique.nom_boutique }}</h3>
                            {% if boutique_data.promo_count > 0 %}
                                <span class="flex-shrink-0 px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded-full ml-2">
                                    {{ boutique_data.promo_count }} promo
                                </span>
                            {% endif %}
                        </div>
                        
                        <p class="text-xs text-gray-500 mb-2">{{ boutique_data.total_produits }} produits</p>
                        
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-star text-yellow-400 mr-1"></i>
                                <span>4.5</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-1"></i>
                                <span>15-25 min</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Promotions al√©atoires -->
    {% if produits_promotion %}
    <section class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">üéÅ Promotions flash</h2>
            <a href="{% url 'clients:recherche' %}?tri=promotion" class="text-green-600 text-sm font-semibold flex items-center">
                Tout voir
                <i class="fas fa-chevron-right ml-1 text-xs"></i>
            </a>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            {% for produit in produits_promotion|slice:":4" %}
            <div class="promo-card bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-md transition-shadow border-2 border-red-100">
                <a href="{% url 'clients:detail_produit' produit.id %}" class="block">
                    <div class="relative">
                        {% if produit.photo %}
                            <img src="{{ produit.photo.url }}" 
                                 alt="{{ produit.nom }}" 
                                 class="w-full h-32 object-cover">
                        {% else %}
                            <div class="w-full h-32 bg-gradient-to-br from-red-100 to-pink-100 flex items-center justify-center">
                                <i class="fas fa-tag text-red-400 text-xl"></i>
                            </div>
                        {% endif %}
                        
                        <span class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs font-semibold rounded-full">
                            -{{ produit.prix|calculate_discount:produit.prix_promotionnel }}%
                        </span>
                    </div>
                    
                    <div class="p-3">
                        <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-2">{{ produit.nom }}</h3>
                        
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-base font-bold text-red-600">{{ produit.prix_promotionnel|format_currency }}</span>
                                <span class="text-xs text-gray-400 line-through">{{ produit.prix|format_currency }}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                            <span>{{ produit.commercant.nom_boutique }}</span>
                            <span>üî• {{ produit.nb_commandes|default:0 }} ventes</span>
                        </div>
                        
                        <button class="w-full py-2 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center"
                                onclick="event.preventDefault(); API.Cart.addItem({{ produit.id }})">
                            <i class="fas fa-bolt mr-1"></i>
                            Ajouter rapidement
                        </button>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Produits populaires (fallback) -->
    {% if produits_populaires and not produits_tendance %}
    <section class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">‚≠ê Produits populaires</h2>
            <a href="{% url 'clients:recherche' %}" class="text-green-600 text-sm font-semibold flex items-center">
                Tout voir
                <i class="fas fa-chevron-right ml-1 text-xs"></i>
            </a>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            {% for produit in produits_populaires|slice:":4" %}
            <div class="product-card bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                <a href="{% url 'clients:detail_produit' produit.id %}" class="block">
                    <div class="relative">
                        {% if produit.photo %}
                            <img src="{{ produit.photo.url }}" 
                                 alt="{{ produit.nom }}" 
                                 class="w-full h-40 object-cover">
                        {% else %}
                            <div class="w-full h-40 bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-box text-gray-400 text-2xl"></i>
                            </div>
                        {% endif %}
                        
                        <button class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center hover:shadow-lg transition-shadow"
                                onclick="event.preventDefault(); toggleFavorite({{ produit.id }}, this)">
                            <i class="fas fa-heart text-gray-400 text-sm"></i>
                        </button>
                    </div>
                    
                    <div class="p-3">
                        <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-1">{{ produit.nom }}</h3>
                        <p class="text-xs text-gray-500 mb-2">{{ produit.commercant.nom_boutique }}</p>
                        
                        <div class="flex items-center mb-2">
                            <div class="flex text-yellow-400 mr-1">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= produit.note_moyenne|default:0 %}
                                        <i class="fas fa-star text-xs"></i>
                                    {% else %}
                                        <i class="far fa-star text-xs"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-xs text-gray-500">({{ produit.nb_avis|default:0 }})</span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                {% if produit.est_en_promotion %}
                                    <div class="flex items-center space-x-1">
                                        <span class="text-base font-bold text-green-600">{{ produit.prix_promotionnel|format_currency }}</span>
                                        <span class="text-xs text-gray-400 line-through">{{ produit.prix|format_currency }}</span>
                                    </div>
                                {% else %}
                                    <span class="text-base font-bold text-green-600">{{ produit.prix|format_currency }}</span>
                                {% endif %}
                            </div>
                            <button class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors"
                                    onclick="event.preventDefault(); API.Cart.addItem({{ produit.id }})">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Section d'authentification pour les utilisateurs non connect√©s -->
    {% if not user.is_authenticated %}
    <div class="px-4 py-6">
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-6 text-white text-center">
            <h2 class="text-lg font-bold mb-2">Rejoignez Local-Links</h2>
            <p class="text-sm text-gray-300 mb-4">Commandez vos produits pr√©f√©r√©s et profitez de la livraison rapide</p>
            <div class="flex space-x-3">
                <a href="{% url 'clients:inscription' %}" class="flex-1 bg-green-500 text-white py-3 rounded-lg text-sm font-semibold text-center hover:bg-green-600 transition-colors">
                    S'inscrire
                </a>
                <a href="{% url 'clients:connexion' %}" class="flex-1 bg-white text-gray-900 py-3 rounded-lg text-sm font-semibold text-center hover:bg-gray-100 transition-colors">
                    Se connecter
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de recherche -->
<div id="search-modal" class="modal fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="modal-content relative bg-white rounded-t-2xl mt-16 max-h-[85vh] overflow-hidden">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">Rechercher</h3>
                <button onclick="closeSearchModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="relative">
                <input type="text" 
                       id="modal-search-input"
                       placeholder="Que cherchez-vous ?" 
                       class="w-full pl-10 pr-4 py-3 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-800 placeholder-gray-500">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
        
        <div class="p-4 overflow-y-auto max-h-[60vh]">
            <div id="search-suggestions" class="space-y-3">
                <!-- Les suggestions de recherche seront charg√©es ici -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonctions pour le modal de recherche
function openSearchModal() {
    document.getElementById('search-modal').classList.remove('hidden');
    document.getElementById('modal-search-input').focus();
}

function closeSearchModal() {
    document.getElementById('search-modal').classList.add('hidden');
    document.getElementById('modal-search-input').value = '';
    document.getElementById('search-suggestions').innerHTML = '';
}

// Toggle favori avec animation
async function toggleFavorite(productId, button) {
    const heartIcon = button.querySelector('i');
    const isFavorited = heartIcon.classList.contains('fas');
    
    if (isFavorited) {
        const result = await API.Favorites.remove(productId);
        if (result && result.success) {
            heartIcon.classList.remove('fas', 'text-red-500');
            heartIcon.classList.add('far', 'text-gray-400');
        }
    } else {
        const result = await API.Favorites.add(productId);
        if (result && result.success) {
            heartIcon.classList.remove('far', 'text-gray-400');
            heartIcon.classList.add('fas', 'text-red-500');
            
            // Animation de like
            button.style.transform = 'scale(1.2)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 200);
        }
    }
}

// Fermer les modals avec la touche √âchap
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSearchModal();
    }
});

// Clic en dehors du modal pour fermer
document.getElementById('search-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeSearchModal();
    }
});

// Charger les suggestions de recherche
document.getElementById('modal-search-input')?.addEventListener('input', async function(e) {
    const query = e.target.value.trim();
    const suggestionsContainer = document.getElementById('search-suggestions');
    
    if (query.length < 2) {
        suggestionsContainer.innerHTML = '';
        return;
    }
    
    suggestionsContainer.innerHTML = `
        <div class="flex justify-center py-4">
            <div class="loader"></div>
        </div>
    `;
    
    try {
        const response = await fetch(`/clients/api/produits/suggestions/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success && data.suggestions.length > 0) {
            suggestionsContainer.innerHTML = data.suggestions.map(product => `
                <a href="/clients/produit/${product.id}/" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 mr-3">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.nom}" class="w-12 h-12 object-cover rounded-lg">` :
                            `<i class="fas fa-box text-gray-400"></i>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-gray-900 truncate">${product.nom}</h4>
                        <p class="text-xs text-gray-500 truncate">${product.boutique_nom}</p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-green-600 font-semibold">${product.prix.toFixed(0)} FCFA</span>
                            ${product.est_en_promotion ? 
                                `<span class="text-xs text-red-600 bg-red-100 px-1 rounded">PROMO</span>` : 
                                ''
                            }
                        </div>
                    </div>
                </a>
            `).join('');
        } else {
            suggestionsContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-2xl mb-2"></i>
                    <p>Aucun r√©sultat trouv√©</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erreur de recherche:', error);
        suggestionsContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Erreur de connexion</p>
            </div>
        `;
    }
});
</script>

<style>
/* Styles suppl√©mentaires pour am√©liorer l'apparence */
.category-card:hover {
    transform: translateY(-2px);
}

.product-card, .boutique-card, .promo-card {
    transition: all 0.3s ease;
}

.product-card:hover, .boutique-card:hover, .promo-card:hover {
    transform: translateY(-2px);
}

.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.modal {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.loader {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #10b981;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}