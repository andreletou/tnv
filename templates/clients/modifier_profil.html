{% extends 'base.html' %}
{% load static %}

{% block title %}Modifier mon profil{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-lg font-semibold">Modifier mon profil</h1>
                </div>
                <button type="submit" form="profileForm" class="text-primary font-medium">
                    Enregistrer
                </button>
            </div>
        </div>
    </header>

    <form method="post" enctype="multipart/form-data" id="profileForm">
        {% csrf_token %}
        
        <!-- Photo de profil -->
        <div class="bg-white p-4 mb-2">
            <div class="text-center">
                <div class="relative inline-block mb-4">
                    <img id="photoPreview" 
                         src="{% if form.instance.photo_profil %}{{ form.instance.photo_profil.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                         alt="Photo de profil" 
                         class="w-24 h-24 rounded-full border-4 border-gray-200 object-cover">
                    <label for="id_photo_profil" class="absolute bottom-0 right-0 bg-primary text-gray-50 p-2 rounded-full cursor-pointer hover:bg-primary/90 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </label>
                    <input type="file" id="id_photo_profil" name="photo_profil" accept="image/*" class="hidden" onchange="previewPhoto(event)">
                </div>
                <p class="text-sm text-gray-500">Appuyez sur l'icône pour changer votre photo</p>
            </div>
        </div>

        <!-- Informations personnelles -->
        <div class="bg-white p-4 mb-2">
            <h3 class="font-semibold mb-4">Informations personnelles</h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.email.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
                    <input type="text" value="{{ form.instance.username }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" disabled>
                    <p class="text-xs text-gray-500 mt-1">Le nom d'utilisateur ne peut pas être modifié</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                    {{ form.telephone }}
                    {% if form.telephone.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.telephone.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                    {{ form.adresse }}
                    {% if form.adresse.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.adresse.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de naissance</label>
                        {{ form.date_naissance }}
                        {% if form.date_naissance.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.date_naissance.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sexe</label>
                        {{ form.sexe }}
                        {% if form.sexe.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.sexe.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Préférences -->
        <div class="bg-white p-4 mb-2">
            <h3 class="font-semibold mb-4">Préférences</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-sm">Notifications par email</p>
                        <p class="text-xs text-gray-500">Recevoir des notifications sur vos commandes et promotions</p>
                    </div>
                    {{ form.preferences_notifications }}
                </div>
            </div>
        </div>

        <!-- Sécurité -->
        <div class="bg-white p-4 mb-20">
            <h3 class="font-semibold mb-4">Sécurité</h3>
            
            <div class="space-y-3">
                <button type="button" onclick="changePassword()" class="w-full flex justify-between items-center py-3 px-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <span class="text-sm font-medium">Changer le mot de passe</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                
                <button type="button" onclick="enable2FA()" class="w-full flex justify-between items-center py-3 px-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <span class="text-sm font-medium">Authentification à deux facteurs</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-xs mx-4">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p class="text-sm text-gray-600">Enregistrement en cours...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Style form inputs
    const inputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="date"], textarea, select');
    inputs.forEach(input => {
        input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-lg', 'focus:ring-2', 'focus:ring-primary', 'focus:border-transparent');
    });
    
    // Style checkbox
    const checkbox = form.querySelector('input[type="checkbox"]');
    if (checkbox) {
        checkbox.classList.add('w-4', 'h-4', 'text-primary', 'border-gray-300', 'rounded', 'focus:ring-primary');
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading
        loadingOverlay.classList.remove('hidden');
        
        // Create FormData for file upload
        const formData = new FormData(form);
        
        // Submit via fetch
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.classList.add('hidden');
            
            if (data.success) {
                showToast('Profil mis à jour avec succès', 'success');
                setTimeout(() => {
                    window.location.href = '/clients/profil/';
                }, 1500);
            } else {
                if (data.errors) {
                    // Display errors
                    Object.keys(data.errors).forEach(field => {
                        const input = form.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                            const errorDiv = document.createElement('p');
                            errorDiv.className = 'text-red-500 text-xs mt-1';
                            errorDiv.textContent = data.errors[field][0];
                            input.parentNode.appendChild(errorDiv);
                        }
                    });
                } else {
                    showToast(data.message || 'Erreur lors de la mise à jour', 'error');
                }
            }
        })
        .catch(error => {
            loadingOverlay.classList.add('hidden');
            console.error('Error:', error);
            
            // Fallback to normal form submission
            form.submit();
        });
    });
    
    // Auto-save draft
    let autoSaveTimer;
    form.addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value instanceof File && value.size === 0) continue;
                data[key] = value;
            }
            localStorage.setItem('profile_draft', JSON.stringify(data));
        }, 2000);
    });
    
    // Load draft if exists
    const draft = localStorage.getItem('profile_draft');
    if (draft) {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && data[key]) {
                input.value = data[key];
            }
        });
    }
    
    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('profile_draft');
    });
});

function previewPhoto(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('photoPreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function changePassword() {
    window.location.href = '/password/change/';
}

function enable2FA() {
    showToast('Configuration de l\'authentification à deux facteurs...', 'info');
}

// Remove error styling on input
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('border-red-500')) {
        e.target.classList.remove('border-red-500');
        const errorDiv = e.target.parentNode.querySelector('.text-red-500');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
});

// Character counter for textarea
const textarea = document.querySelector('textarea[name="adresse"]');
if (textarea) {
    const counter = document.createElement('div');
    counter.className = 'text-xs text-gray-500 mt-1';
    counter.textContent = `${textarea.value.length}/200 caractères`;
    textarea.parentNode.appendChild(counter);
    
    textarea.addEventListener('input', function() {
        counter.textContent = `${this.value.length}/200 caractères`;
        if (this.value.length > 200) {
            this.value = this.value.substring(0, 200);
            counter.classList.add('text-red-500');
        } else {
            counter.classList.remove('text-red-500');
        }
    });
}

// Phone number formatting
const phoneInput = document.querySelector('input[name="telephone"]');
if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        if (value.startsWith('228')) {
            value = '228 ' + value.substring(3).replace(/(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4');
        }
        e.target.value = value;
    });
}
</script>

<style>
/* Custom styles for form elements */
input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(0.5);
}

input[type="file"]::-webkit-file-upload-button {
    visibility: hidden;
}

.form-control:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}