{% extends 'base.html' %}
{% load static %}
{% load custom_filters%}

{% block title %}Recherche{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20">
    <!-- Header avec recherche -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-4">
            <div class="flex items-center space-x-3">
                <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="flex-1 relative">
                    <input type="text" 
                           id="searchInput"
                           value="{{ query }}"
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="Rechercher des produits, boutiques..."
                           autofocus>
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button onclick="toggleFilter()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Filtres -->
        <div id="filterPanel" class="hidden border-t border-gray-200">
            <div class="px-4 py-3">
                <div class="grid grid-cols-2 gap-3">
                    <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Toutes catégories</option>
                        <option value="alimentation">Alimentation</option>
                        <option value="vetements">Vêtements</option>
                        <option value="electronique">Électronique</option>
                        <option value="maison">Maison</option>
                        <option value="beaute">Beauté</option>
                        <option value="sport">Sport</option>
                    </select>
                    
                    <select id="sortFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="pertinence">Pertinence</option>
                        <option value="prix_croissant">Prix croissant</option>
                        <option value="prix_decroissant">Prix décroissant</option>
                        <option value="recent">Plus récents</option>
                        <option value="note">Mieux notés</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-3 mt-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="promoFilter" class="mr-2">
                        <span class="text-sm">En promotion</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="dispoFilter" class="mr-2">
                        <span class="text-sm">Disponible</span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Suggestions de recherche -->
    {% if not query %}
    <div class="bg-white border-b">
        <div class="px-4 py-3">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Recherches populaires</h3>
            <div class="flex flex-wrap gap-2">
                <button onclick="search('Téléphones')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Téléphones</button>
                <button onclick="search('Vêtements')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Vêtements</button>
                <button onclick="search('Chaussures')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Chaussures</button>
                <button onclick="search('Sacs')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Sacs</button>
                <button onclick="search('Montres')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Montres</button>
                <button onclick="search('Ordinateurs')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">Ordinateurs</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Résultats de recherche -->
    <div class="px-4 py-4">
        {% if query %}
        <div class="flex items-center justify-between mb-4">
            <p class="text-sm text-gray-600">
                {{ produits.count|add:boutiques.count }} résultat{{ produits.count|add:boutiques.count|pluralize }} pour "{{ query }}"
            </p>
            <button onclick="toggleView()" class="p-2 hover:bg-gray-100 rounded-lg">
                <svg id="gridViewIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                </svg>
                <svg id="listViewIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        {% endif %}

        <!-- Boutiques -->
        {% if boutiques %}
        <div class="mb-6">
            <h3 class="font-semibold mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                Boutiques ({{ boutiques.count }})
            </h3>
            <div class="grid grid-cols-1 gap-3">
                {% for boutique in boutiques %}
                <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="viewBoutique({{ boutique.id }})">
                    <div class="flex items-center space-x-3">
                        <img src="{% if boutique.photo_boutique %}{{ boutique.photo_boutique.url }}{% else %}{% static 'images/default-store.png' %}{% endif %}" 
                             alt="{{ boutique.nom_boutique }}" 
                             class="w-16 h-16 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-medium">{{ boutique.nom_boutique }}</h4>
                            <p class="text-sm text-gray-500 line-clamp-2">{{ boutique.description|truncatechars:80 }}</p>
                            <div class="flex items-center mt-1">
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ boutique.get_categorie_display }}</span>
                                <span class="text-xs text-gray-500 ml-2">{{ boutique.produits.count }} produits</span>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Produits -->
        {% if produits %}
        <div>
            <h3 class="font-semibold mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                Produits ({{ produits.count }})
            </h3>
            <div id="productsList" class="grid grid-cols-2 gap-4">
                {% for produit in produits %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden product-card">
                    <!-- Image et badges -->
                    <div class="relative">
                        <img src="{{ produit.photo.url }}" 
                             alt="{{ produit.nom }}" 
                             class="w-full h-32 object-cover"
                             onclick="viewProduct({{ produit.id }})">
                        
                        {% if produit.est_en_promotion %}
                        <span class="absolute top-2 left-2 bg-red-500 text-gray-50 text-xs px-2 py-1 rounded-full">
                            -{{ produit.prix|calculate_discount:produit.prix_promotionnel }}%
                        </span>
                        {% endif %}
                        
                        {% if produit.stock <= produit.stock_min %}
                        <span class="absolute top-2 right-2 bg-orange-500 text-gray-50 text-xs px-2 py-1 rounded-full">
                            Stock faible
                        </span>
                        {% endif %}
                        
                        <!-- Bouton favori -->
                        <button onclick="toggleFavori(event, {{ produit.id }})" 
                                class="absolute bottom-2 right-2 bg-white/90 backdrop-blur-sm p-2 rounded-full shadow-md hover:bg-white transition-colors">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Informations produit -->
                    <div class="p-3">
                        <h4 class="font-medium text-sm mb-1 line-clamp-2">{{ produit.nom }}</h4>
                        <p class="text-xs text-gray-500 mb-2">{{ produit.commercant.nom_boutique }}</p>
                        
                        <!-- Prix -->
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                {% if produit.est_en_promotion %}
                                <p class="text-lg font-bold text-primary">{{ produit.prix_promotionnel|format_price }}</p>
                                <p class="text-xs text-gray-400 line-through">{{ produit.prix|format_price }}</p>
                                {% else %}
                                <p class="text-lg font-bold text-primary">{{ produit.prix_effectif|format_price }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Stock</p>
                                <p class="text-sm font-medium {% if produit.stock <= produit.stock_min %}text-orange-500{% else %}text-green-500{% endif %}">
                                    {{ produit.stock }}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2">
                            <button onclick="addToCart({{ produit.id }})" 
                                    class="flex-1 bg-primary text-gray-50 py-2 px-3 rounded-lg text-xs font-medium hover:bg-primary/90 transition-colors flex items-center justify-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Ajouter
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Aucun résultat -->
        {% if query and not produits and not boutiques %}
        <div class="text-center py-12">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun résultat</h3>
            <p class="text-gray-500 mb-4">Aucun produit ou boutique trouvé pour "{{ query }}"</p>
            <div class="space-y-2">
                <p class="text-sm text-gray-600">Suggestions :</p>
                <ul class="text-sm text-gray-500 space-y-1">
                    <li>• Vérifiez l'orthographe de votre recherche</li>
                    <li>• Essayez des mots-clés plus généraux</li>
                    <li>• Utilisez moins de mots</li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let currentView = 'grid';
let searchTimeout;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    
    // Auto-search with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.trim()) {
                performSearch(this.value.trim());
            }
        }, 500);
    });
    
    // Search on Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch(this.value.trim());
        }
    });
    
    // Filter listeners
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortFilter').addEventListener('change', applyFilters);
    document.getElementById('promoFilter').addEventListener('change', applyFilters);
    document.getElementById('dispoFilter').addEventListener('change', applyFilters);
});

function toggleFilter() {
    const filterPanel = document.getElementById('filterPanel');
    filterPanel.classList.toggle('hidden');
}

function search(query) {
    document.getElementById('searchInput').value = query;
    performSearch(query);
}

function performSearch(query) {
    const params = new URLSearchParams({
        q: query,
        category: document.getElementById('categoryFilter').value,
        sort: document.getElementById('sortFilter').value,
        promo: document.getElementById('promoFilter').checked,
        dispo: document.getElementById('dispoFilter').checked
    });
    
    window.location.href = `/clients/recherche/?${params.toString()}`;
}

function applyFilters() {
    const query = document.getElementById('searchInput').value.trim();
    if (query) {
        performSearch(query);
    }
}

function toggleView() {
    const gridIcon = document.getElementById('gridViewIcon');
    const listIcon = document.getElementById('listViewIcon');
    const productsList = document.getElementById('productsList');
    
    if (currentView === 'grid') {
        currentView = 'list';
        gridIcon.classList.add('hidden');
        listIcon.classList.remove('hidden');
        productsList.classList.remove('grid-cols-2');
        productsList.classList.add('space-y-4');
        
        // Convert to list view
        document.querySelectorAll('.product-card').forEach(card => {
            card.classList.add('flex');
            // Transform card layout for list view
        });
    } else {
        currentView = 'grid';
        gridIcon.classList.remove('hidden');
        listIcon.classList.add('hidden');
        productsList.classList.add('grid-cols-2');
        productsList.classList.remove('space-y-4');
        location.reload(); // Simple reload to restore grid
    }
}

function viewProduct(productId) {
    window.location.href = `/clients/produit/${productId}/`;
}

function viewBoutique(boutiqueId) {
    window.location.href = `/clients/boutique/${boutiqueId}/`;
}

function addToCart(productId) {
    fetch('/clients/api/panier/ajouter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ produit_id: productId, quantite: 1 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Produit ajouté au panier', 'success');
            updateCartCount(data.nombre_articles);
        } else {
            showToast(data.message || 'Erreur', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Erreur de connexion', 'error');
    });
}

function toggleFavori(event, productId) {
    event.stopPropagation();
    
    fetch('/clients/api/favoris/ajouter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ produit_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Update heart icon
            const heartIcon = event.currentTarget.querySelector('svg');
            heartIcon.classList.toggle('text-red-500');
            heartIcon.classList.toggle('text-gray-400');
        } else {
            showToast(data.message || 'Erreur', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Erreur de connexion', 'error');
    });
}

// Search suggestions (could be enhanced with API)
const searchSuggestions = [
    'Téléphones', 'Vêtements', 'Chaussures', 'Sacs', 'Montres',
    'Ordinateurs', 'Écouteurs', 'Cosmétiques', 'Livres', 'Jeux'
];

// Recent searches from localStorage
function getRecentSearches() {
    return JSON.parse(localStorage.getItem('recent_searches') || '[]').slice(0, 5);
}

function saveRecentSearch(query) {
    const searches = getRecentSearches();
    const index = searches.indexOf(query);
    if (index > -1) searches.splice(index, 1);
    searches.unshift(query);
    localStorage.setItem('recent_searches', JSON.stringify(searches.slice(0, 10)));
}
</script>
{% endblock %}